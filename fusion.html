<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consolidateur Enedis - Fusionner les fichiers de consommation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .upload-zone {
            border: 3px dashed #ddd;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover {
            border-color: #4facfe;
            background: #f8f9ff;
        }

        .upload-zone.dragover {
            border-color: #4facfe;
            background: #e3f2fd;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #ddd;
            margin-bottom: 20px;
        }

        .upload-zone.dragover .upload-icon {
            color: #4facfe;
        }

        .file-input {
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
        }

        .files-list {
            margin: 20px 0;
        }

        .file-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .file-size {
            color: #666;
            font-size: 0.9em;
        }

        .progress-container {
            margin: 20px 0;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .log-container {
            margin-top: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .log-item {
            padding: 5px 0;
            border-bottom: 1px solid #e9ecef;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .log-item:last-child {
            border-bottom: none;
        }

        .log-success { color: #27ae60; }
        .log-warning { color: #f39c12; }
        .log-error { color: #e74c3c; }
        .log-info { color: #3498db; }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .download-section {
            margin-top: 30px;
            text-align: center;
            display: none;
        }

        .period-info {
            margin: 30px 0;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .period-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
        }

        .period-card h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 1.1em;
        }

        .period-details div {
            margin: 8px 0;
            font-size: 0.95em;
        }

        .period-details strong {
            color: #666;
            display: inline-block;
            width: 60px;
        }

        .gaps-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .gap-item {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 8px;
            margin: 5px 0;
            font-size: 0.9em;
        }

        .no-gaps {
            color: #27ae60;
            font-weight: 500;
            text-align: center;
            padding: 10px;
        }

        .analyzing {
            color: #666;
            font-style: italic;
            text-align: center;
            padding: 10px;
        }

        @media (max-width: 768px) {
            .period-info {
                grid-template-columns: 1fr;
            }
        }

        .consumption-summary {
            margin: 30px 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
        }

        .consumption-summary h4 {
            margin: 0 0 20px 0;
            color: #333;
            font-size: 1.2em;
            text-align: center;
        }

        .summary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 10px 0;
            border-bottom: 1px solid #e9ecef;
            margin-bottom: 15px;
        }

        .summary-header:hover {
            background: rgba(102, 126, 234, 0.1);
            margin: 0 -20px 15px -20px;
            padding: 10px 20px;
            border-radius: 5px;
        }

        .summary-header h4,
        .summary-header h5 {
            margin: 0;
            color: #333;
            font-size: 1.2em;
        }

        .summary-header h5 {
            font-size: 1.1em;
        }

        .toggle-icon {
            font-size: 1.2em;
            color: #667eea;
            transition: transform 0.3s ease;
        }

        .toggle-icon.rotated {
            transform: rotate(180deg);
        }

        .na-analysis {
            margin: 30px 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
            padding: 20px;
        }

        .na-alert {
            margin-bottom: 20px;
        }

        .na-alert h4 {
            margin: 0 0 15px 0;
            color: #e74c3c;
            font-size: 1.2em;
        }

        .na-alert.no-issues h4 {
            color: #27ae60;
        }

        .na-global-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }

        .na-global-info.no-issues {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .na-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }

        .na-stat {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .na-stat-number {
            font-size: 1.5em;
            font-weight: bold;
            color: #e74c3c;
        }

        .na-stat-number.good {
            color: #27ae60;
        }

        .na-table-container {
            max-height: 300px;
            overflow-y: auto;
        }

        .week-detail {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin: 5px 0;
            overflow: hidden;
        }

        .week-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            transition: background 0.2s ease;
        }

        .week-header:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .week-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .week-summary {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .week-name {
            font-weight: 500;
            color: #333;
            min-width: 80px;
        }

        .week-consumption {
            font-weight: bold;
            color: #2ecc71;
            min-width: 120px;
        }

        .week-records {
            color: #666;
            min-width: 60px;
            text-align: center;
        }

        .week-period {
            color: #666;
            font-size: 0.9em;
            min-width: 150px;
            text-align: right;
        }

        .week-toggle {
            font-size: 1.1em;
            color: #667eea;
            transition: transform 0.3s ease;
            margin-left: 10px;
        }

        .week-toggle.expanded {
            transform: rotate(180deg);
        }

        .daily-details {
            display: none;
            padding: 0;
            background: #f8f9fa;
        }

        .daily-details.expanded {
            display: block;
        }

        .daily-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .daily-table th {
            background: #667eea;
            color: white;
            padding: 8px 12px;
            text-align: center;
            font-weight: 500;
        }

        .daily-table td {
            padding: 6px 12px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .daily-table tr:nth-child(even) {
            background: #ffffff;
        }

        .daily-consumption {
            font-weight: 500;
            color: #2ecc71;
        }

        .daily-date {
            font-weight: 500;
            color: #333;
            text-align: left;
        }

        .consumption-table-container {
            overflow-x: auto;
        }

        .consumption-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }

        .consumption-table th,
        .consumption-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .consumption-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 500;
            text-align: center;
        }

        .consumption-table td {
            text-align: center;
        }

        .consumption-table .month-name {
            font-weight: 500;
            color: #333;
        }

        .week-expandable {
            cursor: pointer;
            padding: 12px !important;
        }

        .week-expandable:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .week-details-row {
            background: #f8f9fa;
        }

        .week-details-row td {
            padding: 0 !important;
        }

        .consumption-table .consumption-value {
            font-weight: bold;
            color: #2ecc71;
        }

        .consumption-table .period-cell {
            font-size: 0.8em;
            color: #666;
        }

        .consumption-table tfoot tr {
            background: #f8f9fa;
            font-weight: bold;
        }

        .consumption-table tfoot td {
            border-top: 2px solid #667eea;
            padding: 15px 12px;
        }

        .download-link {
            display: inline-block;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .download-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîå Consolidateur Enedis</h1>
            <p>Fusionnez automatiquement vos fichiers de consommation √©lectrique</p>
        </div>

        <div class="content">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-icon">üìÅ</div>
                <h3>D√©posez vos fichiers Excel Enedis ici</h3>
                <p>ou cliquez pour s√©lectionner des fichiers</p>
                <p><small>Formats accept√©s: .xlsx (fichiers _Export_courbe_de_charge_Consommation_*.xlsx)</small></p>
                <input type="file" id="fileInput" class="file-input" multiple accept=".xlsx">
            </div>



            <div style="text-align: center; margin: 20px 0;">
                <button class="btn" id="processBtn" disabled>üöÄ Consolider les fichiers</button>
                <button class="btn btn-danger" id="clearBtn">üóëÔ∏è Effacer tout</button>
            </div>

            <div class="progress-container" id="progressContainer">
                <p><strong>Progression du traitement:</strong></p>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">0%</p>
            </div>

            <div class="stats" id="statsContainer" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="totalRecords">0</div>
                    <div>Enregistrements</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="filesProcessed">0</div>
                    <div>Fichiers trait√©s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="overlapsFound">0</div>
                    <div>Chevauchements</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="timeChanges">0</div>
                    <div>Changements d'heure</div>
                </div>
            </div>

            <div class="period-info" id="periodInfo" style="display: none;">
                <div class="period-card">
                    <h4>üìÖ P√©riode couverte</h4>
                    <div class="period-details">
                        <div><strong>D√©but:</strong> <span id="periodStart">-</span></div>
                        <div><strong>Fin:</strong> <span id="periodEnd">-</span></div>
                        <div><strong>Dur√©e:</strong> <span id="periodDuration">-</span></div>
                    </div>
                </div>
                <div class="period-card" id="gapsCard">
                    <h4>‚ö†Ô∏è Analyse des donn√©es</h4>
                    <div id="gapsInfo">
                        <div class="analyzing">üîç Analyse en cours...</div>
                    </div>
                    <div id="naInfoInGaps" style="margin-top: 15px; display: none;">
                        <h5 style="margin: 10px 0 5px 0; color: #333; font-size: 1.0em;">üìä Valeurs manquantes (NA)</h5>
                        <div id="naStatsInGaps"></div>
                    </div>
                </div>
            </div>

            <div class="consumption-summary" id="consumptionSummary" style="display: none;">
                <div class="summary-header" onclick="consolidator.toggleSection('monthlyTable')">
                    <h4>‚ö° Consommation mensuelle</h4>
                    <span class="toggle-icon" id="monthlyTableIcon">‚ñº</span>
                </div>
                <div class="consumption-table-container" id="monthlyTable" style="display: none;">
                    <table class="consumption-table" id="consumptionTable">
                        <thead>
                            <tr>
                                <th>Mois</th>
                                <th>Consommation (kWh)</th>
                                <th>Nombre d'enregistrements</th>
                                <th>P√©riode</th>
                            </tr>
                        </thead>
                        <tbody id="consumptionTableBody">
                        </tbody>
                        <tfoot id="consumptionTableFoot">
                        </tfoot>
                    </table>
                </div>
            </div>

            <div class="consumption-summary" id="weeklyConsumptionSummary" style="display: none;">
                <div class="summary-header" onclick="consolidator.toggleSection('weeklyTable')">
                    <h4>üìÖ Consommation hebdomadaire</h4>
                    <span class="toggle-icon" id="weeklyTableIcon">‚ñº</span>
                </div>
                <div class="consumption-table-container" id="weeklyTable" style="display: none;">
                    <div id="weeklyConsumptionTableContainer"></div>
                    <table class="consumption-table" id="weeklyConsumptionTable" style="display: none;">
                        <tfoot id="weeklyConsumptionTableFoot">
                        </tfoot>
                    </table>
                </div>
            </div>



            <div class="download-section" id="downloadSection">
                <h3>‚úÖ Traitement termin√© avec succ√®s!</h3>
                <a href="#" id="downloadLink" class="download-link">üì• T√©l√©charger le fichier consolid√©</a>
            </div>

            <div class="log-container">
                <h4>üìã Journal d'activit√©</h4>
                <div id="logContent"></div>
            </div>
        </div>
    </div>

    <script>
        class EnedisConsolidator {
            constructor() {
                this.files = [];
                this.consolidatedData = [];
                this.overlaps = [];
                this.stats = {
                    totalRecords: 0,
                    filesProcessed: 0,
                    overlapsFound: 0,
                    timeChanges: 0
                };
                
                this.initializeEvents();
                this.log('üöÄ Application initialis√©e. Pr√™t √† traiter vos fichiers Enedis!', 'info');
            }

            initializeEvents() {
                const uploadZone = document.getElementById('uploadZone');
                const fileInput = document.getElementById('fileInput');
                const processBtn = document.getElementById('processBtn');
                const clearBtn = document.getElementById('clearBtn');

                // Upload zone events
                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files);
                });

                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files);
                });

                processBtn.addEventListener('click', () => this.processFiles());
                clearBtn.addEventListener('click', () => this.clearAll());
            }

            handleFiles(fileList) {
                const validFiles = Array.from(fileList).filter(file => {
                    return file.name.includes('_Export_courbe_de_charge_Consommation_') && 
                           file.name.endsWith('.xlsx');
                });

                if (validFiles.length === 0) {
                    this.log('‚ö†Ô∏è Aucun fichier Enedis valide d√©tect√©. V√©rifiez que vos fichiers contiennent "_Export_courbe_de_charge_Consommation_" dans le nom.', 'warning');
                    return;
                }

                this.files = [...this.files, ...validFiles];
                this.updateProcessButton();
                
                this.log(`üìÅ ${validFiles.length} fichier(s) ajout√©(s). Total: ${this.files.length}`, 'success');
            }

            updateProcessButton() {
                const processBtn = document.getElementById('processBtn');
                processBtn.disabled = this.files.length === 0;
            }

            async processFiles() {
                if (this.files.length === 0) return;

                this.log('üîÑ D√©but du traitement...', 'info');
                this.showProgress();
                this.resetStats();

                const allData = {};
                const overlaps = [];
                let totalRecords = 0;

                for (let i = 0; i < this.files.length; i++) {
                    const file = this.files[i];
                    const progress = ((i + 1) / this.files.length) * 100;
                    
                    this.updateProgress(progress, `Traitement: ${file.name}`);
                    this.log(`üìÑ Traitement du fichier: ${file.name}`, 'info');

                    try {
                        const data = await this.processFile(file);
                        
                        data.forEach(record => {
                            const key = `${record.debut}-${record.fin}`;
                            
                            // V√©rifier le changement d'heure
                            const isTimeChange = record.debut.includes('27/10/') && 
                                                (record.debut.includes('01:30:00') || record.debut.includes('02:00:00'));
                            
                            if (allData[key] && allData[key].valeur !== record.valeur) {
                                if (isTimeChange) {
                                    this.stats.timeChanges++;
                                    // Garder les deux enregistrements pour le changement d'heure
                                    allData[`${key}_bis`] = { ...record, note: 'Changement d\'heure' };
                                } else {
                                    overlaps.push({
                                        debut: record.debut,
                                        fin: record.fin,
                                        valeur1: allData[key].valeur,
                                        valeur2: record.valeur,
                                        fichier: file.name
                                    });
                                    this.stats.overlapsFound++;
                                }
                            } else {
                                allData[key] = record;
                            }
                            totalRecords++;
                        });

                        this.stats.filesProcessed++;
                        this.log(`‚úÖ ${file.name}: ${data.length} enregistrements trait√©s`, 'success');

                    } catch (error) {
                        this.log(`‚ùå Erreur avec ${file.name}: ${error.message}`, 'error');
                    }
                }

                // Trier les donn√©es par date avec gestion sp√©ciale des changements d'heure
                const sortedData = Object.values(allData).sort((a, b) => {
                    const dateA = this.parseDate(a.debut);
                    const dateB = this.parseDate(b.debut);
                    
                    // Si les deux dates sont le m√™me jour
                    if (dateA.toDateString() === dateB.toDateString()) {
                        const timeChangeA = this.isTimeChange(a.debut);
                        const timeChangeB = this.isTimeChange(b.debut);
                        
                        // Si c'est un changement d'heure d'√©t√© (passage √† l'heure d'√©t√©)
                        if (timeChangeA.type === 'spring' || timeChangeB.type === 'spring') {
                            // Pour le passage √† l'heure d'√©t√©, on doit g√©rer l'ordre sp√©cial
                            // 01:30-02:00, 02:00-02:30, puis directement 03:00-03:30, 03:30-04:00
                            
                            const hourA = dateA.getHours();
                            const hourB = dateB.getHours();
                            const minuteA = dateA.getMinutes();
                            const minuteB = dateB.getMinutes();
                            
                            // Cr√©er une cl√© de tri sp√©ciale pour l'heure d'√©t√©
                            const getSortKey = (hour, minute) => {
                                if (hour < 2) return hour * 100 + minute; // 0:xx, 1:xx normaux
                                if (hour === 2) return 200 + minute; // 2:xx avant le saut
                                if (hour >= 3) return (hour + 100) * 100 + minute; // 3:xx et + apr√®s le saut
                                return hour * 100 + minute;
                            };
                            
                            const keyA = getSortKey(hourA, minuteA);
                            const keyB = getSortKey(hourB, minuteB);
                            
                            return keyA - keyB;
                        }
                    }
                    
                    // Tri normal pour tous les autres cas
                    return dateA - dateB;
                });

                this.stats.totalRecords = sortedData.length;
                this.consolidatedData = sortedData;
                this.overlaps = overlaps;

                this.updateProgress(100, 'G√©n√©ration du fichier Excel...');
                await this.generateExcelFile();

                this.hideProgress();
                this.showResults();
                this.updateStats();
                
                this.log(`üéâ Traitement termin√©! ${this.stats.totalRecords} enregistrements consolid√©s`, 'success');
            }

            async processFile(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = (e) => {
                        try {
                            const data = new Uint8Array(e.target.result);
                            const workbook = XLSX.read(data, { type: 'array' });

                            if (!workbook.SheetNames.includes('Consommation Horaire')) {
                                throw new Error('Feuille "Consommation Horaire" non trouv√©e');
                            }

                            const worksheet = workbook.Sheets['Consommation Horaire'];
                            const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                            // Trouver les en-t√™tes
                            let headerRow = -1;
                            for (let i = 0; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row.includes('D√©but') && row.includes('Fin') && 
                                    row.some(cell => cell && cell.toString().includes('Valeur'))) {
                                    headerRow = i;
                                    break;
                                }
                            }

                            if (headerRow === -1) {
                                throw new Error('En-t√™tes non trouv√©s');
                            }

                            const headers = jsonData[headerRow];
                            const debutIndex = headers.indexOf('D√©but');
                            const finIndex = headers.indexOf('Fin');
                            const valeurIndex = headers.findIndex(h => h && h.toString().includes('Valeur'));

                            const records = [];
                            let dateFormatDetected = '';
                            
                            for (let i = headerRow + 1; i < jsonData.length; i++) {
                                const row = jsonData[i];
                                if (row[debutIndex] && row[finIndex] && row[valeurIndex]) {
                                    const debutRaw = row[debutIndex];
                                    const finRaw = row[finIndex];
                                    
                                    // D√©tecter le format de date sur le premier enregistrement
                                    if (records.length === 0 && typeof debutRaw === 'string') {
                                        const frenchFormat = /^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}$/;
                                        if (frenchFormat.test(debutRaw)) {
                                            dateFormatDetected = 'DD/MM/YYYY HH:MM:SS (format fran√ßais)';
                                        } else {
                                            dateFormatDetected = 'Format non standard d√©tect√©';
                                        }
                                    }
                                    
                                    records.push({
                                        debut: this.formatDate(debutRaw),
                                        fin: this.formatDate(finRaw),
                                        valeur: row[valeurIndex],
                                        _formatInfo: dateFormatDetected
                                    });
                                }
                            }
                            
                            // Log du format d√©tect√©
                            if (dateFormatDetected) {
                                console.log(`Format de date d√©tect√©: ${dateFormatDetected}`);
                            }

                            resolve(records);
                        } catch (error) {
                            reject(error);
                        }
                    };

                    reader.onerror = () => reject(new Error('Erreur de lecture du fichier'));
                    reader.readAsArrayBuffer(file);
                });
            }

            formatDate(dateValue) {
                // Enedis utilise le format DD/MM/YYYY HH:MM:SS (format fran√ßais)
                if (typeof dateValue === 'string') {
                    // Si c'est d√©j√† au bon format DD/MM/YYYY HH:MM:SS, le garder tel quel
                    const frenchDatePattern = /^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}$/;
                    if (frenchDatePattern.test(dateValue)) {
                        return dateValue; // Format fran√ßais d√©tect√©, on le garde
                    }
                }
                
                if (dateValue instanceof Date) {
                    // Convertir l'objet Date en format fran√ßais DD/MM/YYYY HH:MM:SS
                    const day = dateValue.getDate().toString().padStart(2, '0');
                    const month = (dateValue.getMonth() + 1).toString().padStart(2, '0');
                    const year = dateValue.getFullYear();
                    const hours = dateValue.getHours().toString().padStart(2, '0');
                    const minutes = dateValue.getMinutes().toString().padStart(2, '0');
                    const seconds = dateValue.getSeconds().toString().padStart(2, '0');
                    
                    return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
                }
                
                // Pour les autres formats, essayer de parser intelligemment
                if (typeof dateValue === 'string') {
                    try {
                        // Essayer de parser en tant que date
                        const date = new Date(dateValue);
                        if (!isNaN(date.getTime())) {
                            const day = date.getDate().toString().padStart(2, '0');
                            const month = (date.getMonth() + 1).toString().padStart(2, '0');
                            const year = date.getFullYear();
                            const hours = date.getHours().toString().padStart(2, '0');
                            const minutes = date.getMinutes().toString().padStart(2, '0');
                            const seconds = date.getSeconds().toString().padStart(2, '0');
                            
                            return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
                        }
                    } catch (e) {
                        // Si la conversion √©choue, retourner la valeur originale
                    }
                }
                
                return dateValue;
            }

            parseDate(dateStr) {
                // Parse une date au format fran√ßais DD/MM/YYYY HH:MM:SS
                // Exemple: "01/06/2024 00:00:00" = 1er juin 2024
                const [datePart, timePart] = dateStr.split(' ');
                const [day, month, year] = datePart.split('/');
                const [hours, minutes, seconds] = timePart.split(':');
                
                // IMPORTANT: month - 1 car JavaScript utilise des mois 0-11
                // day et year restent tels quels
                return new Date(
                    parseInt(year),      // ann√©e
                    parseInt(month) - 1, // mois (0-11 en JavaScript)
                    parseInt(day),       // jour
                    parseInt(hours),     // heures
                    parseInt(minutes),   // minutes
                    parseInt(seconds)    // secondes
                );
            }

            getLastSundayOfMonth(year, month) {
                // Trouver le dernier dimanche d'un mois donn√©
                const lastDay = new Date(year, month + 1, 0); // Dernier jour du mois
                const dayOfWeek = lastDay.getDay(); // 0 = dimanche, 1 = lundi, etc.
                
                // Calculer combien de jours soustraire pour arriver au dimanche
                const daysToSubtract = dayOfWeek === 0 ? 0 : dayOfWeek;
                
                return new Date(year, month, lastDay.getDate() - daysToSubtract);
            }

            isSameDay(date1, date2) {
                return date1.getFullYear() === date2.getFullYear() &&
                       date1.getMonth() === date2.getMonth() &&
                       date1.getDate() === date2.getDate();
            }

            isTimeChange(dateStr) {
                const date = this.parseDate(dateStr);
                const year = date.getFullYear();
                
                // Dernier dimanche de mars (passage √† l'heure d'√©t√© - on perd 1h)
                const lastSundayMarch = this.getLastSundayOfMonth(year, 2); // Mars = mois 2
                
                // Dernier dimanche d'octobre (passage √† l'heure d'hiver - on gagne 1h)
                const lastSundayOctober = this.getLastSundayOfMonth(year, 9); // Octobre = mois 9
                
                // Passage √† l'heure d'√©t√© (mars) : la tranche 02:00-03:00 n'existe pas
                // Donc on peut avoir des cr√©neaux qui sautent directement de 01:30-02:00 √† 03:00-03:30
                const isSpringChange = this.isSameDay(date, lastSundayMarch) && 
                                      (dateStr.includes('02:00:00') || dateStr.includes('02:30:00') ||
                                       dateStr.includes('03:00:00'));
                
                // Passage √† l'heure d'hiver (octobre) : la tranche 02:00-03:00 existe en double
                // Les cr√©neaux 01:30-02:00, 02:00-02:30, 02:30-03:00 peuvent √™tre dupliqu√©s
                const isAutumnChange = this.isSameDay(date, lastSundayOctober) && 
                                      (dateStr.includes('01:30:00') || dateStr.includes('02:00:00') || 
                                       dateStr.includes('02:30:00') || dateStr.includes('03:00:00'));
                
                return {
                    isChange: isSpringChange || isAutumnChange,
                    type: isSpringChange ? 'spring' : (isAutumnChange ? 'autumn' : null),
                    date: isSpringChange ? lastSundayMarch : (isAutumnChange ? lastSundayOctober : null)
                };
            }

            async generateExcelFile() {
                // Cr√©er un nouveau workbook
                const wb = XLSX.utils.book_new();

                // Feuille principale avec les donn√©es consolid√©es
                const wsData = this.consolidatedData.map(record => ({
                    'Date d√©but': record.debut,
                    'Date fin': record.fin,
                    'Valeur (kW)': record.valeur,
                    'Note': record.note || ''
                }));

                const ws = XLSX.utils.json_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, 'Consommation Consolid√©e');

                // Feuille des chevauchements si n√©cessaire
                if (this.overlaps.length > 0) {
                    const wsOverlaps = XLSX.utils.json_to_sheet(this.overlaps);
                    XLSX.utils.book_append_sheet(wb, wsOverlaps, 'Chevauchements');
                }

                // G√©n√©rer le fichier
                const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
                const blob = new Blob([wbout], { type: 'application/octet-stream' });
                
                // Cr√©er le lien de t√©l√©chargement
                const url = URL.createObjectURL(blob);
                const downloadLink = document.getElementById('downloadLink');
                downloadLink.href = url;
                downloadLink.download = 'Consommation_Consolidee.xlsx';
            }

            showProgress() {
                document.getElementById('progressContainer').style.display = 'block';
            }

            hideProgress() {
                document.getElementById('progressContainer').style.display = 'none';
            }

            updateProgress(percent, text) {
                document.getElementById('progressFill').style.width = percent + '%';
                document.getElementById('progressText').textContent = `${Math.round(percent)}% - ${text}`;
            }

            showResults() {
                document.getElementById('downloadSection').style.display = 'block';
                document.getElementById('statsContainer').style.display = 'grid';
                document.getElementById('periodInfo').style.display = 'grid';
                document.getElementById('consumptionSummary').style.display = 'block';
                document.getElementById('weeklyConsumptionSummary').style.display = 'block';
                this.analyzePeriodAndGaps();
                this.calculateMonthlyConsumption();
                this.calculateWeeklyConsumption();
                this.analyzeNAValues();
            }

            updateStats() {
                document.getElementById('totalRecords').textContent = this.stats.totalRecords;
                document.getElementById('filesProcessed').textContent = this.stats.filesProcessed;
                document.getElementById('overlapsFound').textContent = this.stats.overlapsFound;
                document.getElementById('timeChanges').textContent = this.stats.timeChanges;
            }

            analyzePeriodAndGaps() {
                if (this.consolidatedData.length === 0) return;

                // Analyser la p√©riode
                const firstRecord = this.consolidatedData[0];
                const lastRecord = this.consolidatedData[this.consolidatedData.length - 1];
                
                const startDate = this.parseDate(firstRecord.debut);
                const endDate = this.parseDate(lastRecord.fin);
                
                // Calculer la dur√©e
                const durationMs = endDate - startDate;
                const durationDays = Math.floor(durationMs / (1000 * 60 * 60 * 24));
                const durationHours = Math.floor((durationMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                
                // Mettre √† jour l'affichage de la p√©riode
                document.getElementById('periodStart').textContent = firstRecord.debut;
                document.getElementById('periodEnd').textContent = lastRecord.fin;
                document.getElementById('periodDuration').textContent = 
                    `${durationDays} jour(s) et ${durationHours} heure(s)`;

                // Analyser les manques (gaps)
                this.analyzeGaps();
            }

            analyzeGaps() {
                const gaps = [];
                const gapsInfo = document.getElementById('gapsInfo');
                
                // V√©rifier la continuit√© entre chaque enregistrement
                for (let i = 0; i < this.consolidatedData.length - 1; i++) {
                    const current = this.consolidatedData[i];
                    const next = this.consolidatedData[i + 1];
                    
                    const currentEnd = this.parseDate(current.fin);
                    const nextStart = this.parseDate(next.debut);
                    
                    // Si il y a un √©cart de plus de 1 minute (pour tol√©rer les petites diff√©rences)
                    const diffMs = nextStart - currentEnd;
                    if (diffMs > 60000) { // Plus d'1 minute
                        
                        // V√©rifier si c'est un "faux manque" d√ª au changement d'heure
                        const isTimeChangeGap = this.isTimeChangeRelatedGap(current, next);
                        
                        if (!isTimeChangeGap) {
                            const diffHours = diffMs / (1000 * 60 * 60);
                            gaps.push({
                                from: current.fin,
                                to: next.debut,
                                duration: diffHours
                            });
                        }
                    }
                }

                // Afficher les r√©sultats
                if (gaps.length === 0) {
                    gapsInfo.innerHTML = '<div class="no-gaps">‚úÖ Aucun manque d√©tect√© - Donn√©es continues</div>';
                } else {
                    let gapsHtml = `<div style="margin-bottom: 10px;"><strong>‚ö†Ô∏è ${gaps.length} manque(s) d√©tect√©(s):</strong></div>`;
                    gapsHtml += '<div class="gaps-list">';
                    
                    gaps.forEach(gap => {
                        const durationText = gap.duration < 1 ? 
                            `${Math.round(gap.duration * 60)} min` : 
                            `${gap.duration.toFixed(1)}h`;
                        
                        gapsHtml += `
                            <div class="gap-item">
                                <strong>Du:</strong> ${gap.from}<br>
                                <strong>Au:</strong> ${gap.to}<br>
                                <strong>Dur√©e:</strong> ${durationText}
                            </div>
                        `;
                    });
                    
                    gapsHtml += '</div>';
                    gapsInfo.innerHTML = gapsHtml;
                }

                this.log(`üîç Analyse: ${gaps.length} manque(s) de donn√©es d√©tect√©(s)`, gaps.length > 0 ? 'warning' : 'success');
            }

            isTimeChangeRelatedGap(current, next) {
                // V√©rifier si l'√©cart entre deux enregistrements est d√ª √† un changement d'heure
                const currentEndDate = this.parseDate(current.fin);
                const nextStartDate = this.parseDate(next.debut);
                
                // V√©rifier si c'est le m√™me jour
                if (currentEndDate.toDateString() !== nextStartDate.toDateString()) {
                    return false;
                }
                
                // V√©rifier si c'est un jour de changement d'heure
                const timeChangeInfo = this.isTimeChange(current.fin);
                if (!timeChangeInfo.isChange) {
                    return false;
                }
                
                // Pour le passage √† l'heure d'√©t√© (mars)
                if (timeChangeInfo.type === 'spring') {
                    // Cas sp√©cifique : 03:00:00 -> 03:30:00 avec un enregistrement 02:30:00 -> 03:00:00 plac√© apr√®s
                    // C'est normal et ne constitue pas un manque r√©el
                    const currentHour = currentEndDate.getHours();
                    const nextHour = nextStartDate.getHours();
                    
                    // Si on a 03:00 -> 03:30 et qu'on d√©tecte un changement d'heure, c'est normal
                    if (currentHour === 3 && nextHour === 3) {
                        return true;
                    }
                }
                
                // Pour le passage √† l'heure d'hiver (octobre)
                if (timeChangeInfo.type === 'autumn') {
                    // Les cr√©neaux peuvent se chevaucher, c'est normal
                    const currentHour = currentEndDate.getHours();
                    const nextHour = nextStartDate.getHours();
                    
                    if ((currentHour === 2 || currentHour === 3) && (nextHour === 2 || nextHour === 3)) {
                        return true;
                    }
                }
                
                return false;
            }

            calculateMonthlyConsumption() {
                const monthlyData = {};
                let totalConsumption = 0;
                let totalRecords = 0;

                this.consolidatedData.forEach(record => {
                    // Parser les dates
                    const startDate = this.parseDate(record.debut);
                    const endDate = this.parseDate(record.fin);
                    
                    // Calculer la dur√©e en heures avec plus de pr√©cision
                    const durationMs = endDate - startDate;
                    const durationHours = Math.round((durationMs / (1000 * 60 * 60)) * 1000000) / 1000000; // 6 d√©cimales
                    
                    // Convertir la valeur en nombre (g√©rer les virgules fran√ßaises)
                    let powerKW = 0;
                    if (record.valeur && record.valeur !== 'NA') {
                        powerKW = typeof record.valeur === 'string' ? 
                                 parseFloat(record.valeur.replace(',', '.')) : 
                                 parseFloat(record.valeur);
                        
                        // V√©rifier que c'est un nombre valide
                        if (isNaN(powerKW)) {
                            powerKW = 0;
                        }
                    }
                    
                    // Calculer la consommation en kWh avec plus de pr√©cision
                    const consumptionKWh = Math.round((powerKW * durationHours) * 1000000) / 1000000; // 6 d√©cimales
                    
                    // Cr√©er la cl√© du mois (YYYY-MM)
                    const year = startDate.getFullYear();
                    const month = startDate.getMonth();
                    const monthKey = `${year}-${month.toString().padStart(2, '0')}`;
                    const monthName = startDate.toLocaleDateString('fr-FR', { year: 'numeric', month: 'long' });
                    
                    // Initialiser le mois si n√©cessaire
                    if (!monthlyData[monthKey]) {
                        monthlyData[monthKey] = {
                            name: monthName,
                            consumption: 0,
                            records: 0,
                            firstDate: record.debut,
                            lastDate: record.fin,
                            year: year,
                            month: month
                        };
                    }
                    
                    // Ajouter les donn√©es
                    monthlyData[monthKey].consumption += consumptionKWh;
                    monthlyData[monthKey].records++;
                    monthlyData[monthKey].lastDate = record.fin;
                    
                    totalConsumption += consumptionKWh;
                    totalRecords++;
                });

                // Trier par date
                const sortedMonths = Object.keys(monthlyData).sort();
                
                // G√©n√©rer le tableau
                const tableBody = document.getElementById('consumptionTableBody');
                const tableFoot = document.getElementById('consumptionTableFoot');
                
                tableBody.innerHTML = '';
                
                sortedMonths.forEach(monthKey => {
                    const data = monthlyData[monthKey];
                    const row = document.createElement('tr');
                    
                    // Formater la p√©riode
                    const startDate = data.firstDate.split(' ')[0];
                    const endDate = data.lastDate.split(' ')[0];
                    const period = startDate === endDate ? startDate : `${startDate} ‚Üí ${endDate}`;
                    
                    row.innerHTML = `
                        <td class="month-name">${data.name}</td>
                        <td class="consumption-value">${data.consumption.toFixed(3)} kWh</td>
                        <td>${data.records}</td>
                        <td class="period-cell">${period}</td>
                    `;
                    
                    tableBody.appendChild(row);
                });

                // Ajouter le total
                tableFoot.innerHTML = `
                    <tr>
                        <td><strong>TOTAL</strong></td>
                        <td><strong>${totalConsumption.toFixed(3)} kWh</strong></td>
                        <td><strong>${totalRecords}</strong></td>
                        <td><strong>${sortedMonths.length} mois</strong></td>
                    </tr>
                `;

                this.log(`üìä Consommation calcul√©e: ${totalConsumption.toFixed(3)} kWh sur ${sortedMonths.length} mois`, 'success');
            }

            getWeekNumber(date) {
                // Calculer le num√©ro de semaine ISO 8601
                const target = new Date(date.valueOf());
                const dayNr = (date.getDay() + 6) % 7;
                target.setDate(target.getDate() - dayNr + 3);
                const firstThursday = target.valueOf();
                target.setMonth(0, 1);
                if (target.getDay() !== 4) {
                    target.setMonth(0, 1 + ((4 - target.getDay()) + 7) % 7);
                }
                const weekNumber = 1 + Math.ceil((firstThursday - target) / 604800000);
                return {
                    year: target.getFullYear(),
                    week: weekNumber
                };
            }

            calculateWeeklyConsumption() {
                const weeklyData = {};
                const dailyData = {}; // Pour stocker les d√©tails par jour
                let totalConsumption = 0;
                let totalRecords = 0;

                this.consolidatedData.forEach(record => {
                    // Parser les dates
                    const startDate = this.parseDate(record.debut);
                    const endDate = this.parseDate(record.fin);
                    
                    // Calculer la dur√©e en heures avec plus de pr√©cision
                    const durationMs = endDate - startDate;
                    const durationHours = Math.round((durationMs / (1000 * 60 * 60)) * 1000000) / 1000000;
                    
                    // Convertir la valeur en nombre
                    let powerKW = 0;
                    if (record.valeur && record.valeur !== 'NA') {
                        powerKW = typeof record.valeur === 'string' ? 
                                 parseFloat(record.valeur.replace(',', '.')) : 
                                 parseFloat(record.valeur);
                        
                        if (isNaN(powerKW)) {
                            powerKW = 0;
                        }
                    }
                    
                    // Calculer la consommation en kWh
                    const consumptionKWh = Math.round((powerKW * durationHours) * 1000000) / 1000000;
                    
                    // Obtenir le num√©ro de semaine
                    const weekInfo = this.getWeekNumber(startDate);
                    const weekKey = `${weekInfo.year}-W${weekInfo.week.toString().padStart(2, '0')}`;
                    
                    // Obtenir la date du jour
                    const dayKey = startDate.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit', 
                        year: 'numeric'
                    });
                    
                    // Initialiser la semaine si n√©cessaire
                    if (!weeklyData[weekKey]) {
                        weeklyData[weekKey] = {
                            year: weekInfo.year,
                            week: weekInfo.week,
                            consumption: 0,
                            records: 0,
                            firstDate: record.debut,
                            lastDate: record.fin,
                            days: []
                        };
                    }
                    
                    // Initialiser le jour si n√©cessaire
                    if (!dailyData[weekKey]) {
                        dailyData[weekKey] = {};
                    }
                    if (!dailyData[weekKey][dayKey]) {
                        dailyData[weekKey][dayKey] = {
                            date: dayKey,
                            dateObj: startDate,
                            consumption: 0,
                            records: 0,
                            naCount: 0
                        };
                    }
                    
                    // Ajouter les donn√©es √† la semaine
                    weeklyData[weekKey].consumption += consumptionKWh;
                    weeklyData[weekKey].records++;
                    weeklyData[weekKey].lastDate = record.fin;
                    
                    // Ajouter les donn√©es au jour
                    dailyData[weekKey][dayKey].consumption += consumptionKWh;
                    dailyData[weekKey][dayKey].records++;
                    if (!record.valeur || record.valeur === 'NA') {
                        dailyData[weekKey][dayKey].naCount++;
                    }
                    
                    totalConsumption += consumptionKWh;
                    totalRecords++;
                });

                // Trier par ann√©e et semaine
                const sortedWeeks = Object.keys(weeklyData).sort();
                
                // G√©n√©rer le contenu avec d√©tails par jour
                const container = document.getElementById('weeklyConsumptionTableContainer');
                const tableFoot = document.getElementById('weeklyConsumptionTableFoot');
                
                let htmlContent = `
                    <table class="consumption-table">
                        <thead>
                            <tr>
                                <th>Semaine</th>
                                <th>Consommation (kWh)</th>
                                <th>Nombre d'enregistrements</th>
                                <th>P√©riode</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                sortedWeeks.forEach(weekKey => {
                    const data = weeklyData[weekKey];
                    const weekName = `${data.year} S${data.week.toString().padStart(2, '0')}`;
                    const startDate = data.firstDate.split(' ')[0];
                    const endDate = data.lastDate.split(' ')[0];
                    const period = startDate === endDate ? startDate : `${startDate} ‚Üí ${endDate}`;
                    
                    // Nettoyer la cl√© pour √©viter les probl√®mes
                    const cleanWeekKey = weekKey.replace(/[^a-zA-Z0-9]/g, '');
                    
                    htmlContent += `
                        <tr class="week-main-row">
                            <td class="week-expandable" onclick="consolidator.toggleWeekDetails('${cleanWeekKey}')">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span>${weekName}</span>
                                    <span class="week-toggle" id="weekToggle${cleanWeekKey}">‚ñº</span>
                                </div>
                            </td>
                            <td class="consumption-value">${data.consumption.toFixed(3)} kWh</td>
                            <td>${data.records}</td>
                            <td class="period-cell">${period}</td>
                        </tr>
                        <tr id="weekDetails${cleanWeekKey}" class="week-details-row" style="display: none;">
                            <td colspan="4" style="padding: 0;">
                                <div style="background: #f8f9fa; padding: 15px;">
                                    <h5 style="margin: 0 0 10px 0; color: #333;">üìä D√©tail par jour - ${weekName}</h5>
                                    <table class="daily-table">
                                        <thead>
                                            <tr>
                                                <th>Date</th>
                                                <th>Consommation (kWh)</th>
                                                <th>Enregistrements</th>
                                                <th>Valeurs NA</th>
                                                <th>% NA</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                    `;
                    
                    // Trier les jours de la semaine
                    const daysOfWeek = Object.values(dailyData[weekKey] || {}).sort((a, b) => a.dateObj - b.dateObj);
                    
                    daysOfWeek.forEach(day => {
                        const naPercentage = day.records > 0 ? ((day.naCount / day.records) * 100).toFixed(1) : '0.0';
                        htmlContent += `
                            <tr>
                                <td class="daily-date">${day.date}</td>
                                <td class="daily-consumption">${day.consumption.toFixed(3)} kWh</td>
                                <td>${day.records}</td>
                                <td style="color: ${day.naCount > 0 ? '#e74c3c' : '#27ae60'}; font-weight: ${day.naCount > 0 ? 'bold' : 'normal'};">${day.naCount}</td>
                                <td>${naPercentage}%</td>
                            </tr>
                        `;
                    });
                    
                    htmlContent += `
                                        </tbody>
                                    </table>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                htmlContent += `
                        </tbody>
                    </table>
                `;
                
                container.innerHTML = htmlContent;

                // Ajouter le total
                tableFoot.innerHTML = `
                    <tr>
                        <td><strong>TOTAL</strong></td>
                        <td><strong>${totalConsumption.toFixed(3)} kWh</strong></td>
                        <td><strong>${totalRecords}</strong></td>
                        <td><strong>${sortedWeeks.length} semaines</strong></td>
                    </tr>
                `;

                this.log(`üìÖ Consommation hebdomadaire calcul√©e: ${totalConsumption.toFixed(3)} kWh sur ${sortedWeeks.length} semaines`, 'success');
            }

            toggleWeekDetails(cleanWeekKey) {
                const detailsRow = document.getElementById(`weekDetails${cleanWeekKey}`);
                const toggleIcon = document.getElementById(`weekToggle${cleanWeekKey}`);
                
                if (detailsRow && toggleIcon) {
                    if (detailsRow.style.display === 'none') {
                        detailsRow.style.display = 'table-row';
                        toggleIcon.textContent = '‚ñ≤';
                        toggleIcon.classList.add('expanded');
                    } else {
                        detailsRow.style.display = 'none';
                        toggleIcon.textContent = '‚ñº';
                        toggleIcon.classList.remove('expanded');
                    }
                } else {
                    console.log('√âl√©ments non trouv√©s:', cleanWeekKey);
                }
            }

            toggleSection(sectionId) {
                const section = document.getElementById(sectionId);
                const icon = document.getElementById(sectionId + 'Icon');
                
                if (section.style.display === 'none') {
                    section.style.display = 'block';
                    icon.classList.add('rotated');
                } else {
                    section.style.display = 'none';
                    icon.classList.remove('rotated');
                }
            }

            analyzeNAValues() {
                const naByDay = {};
                let totalNA = 0;
                let totalRecords = 0;

                this.consolidatedData.forEach(record => {
                    const startDate = this.parseDate(record.debut);
                    const dateKey = startDate.toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit', 
                        year: 'numeric'
                    });

                    if (!naByDay[dateKey]) {
                        naByDay[dateKey] = {
                            na: 0,
                            total: 0,
                            date: startDate
                        };
                    }

                    naByDay[dateKey].total++;
                    totalRecords++;

                    if (!record.valeur || record.valeur === 'NA' || record.valeur === '' || record.valeur === null) {
                        naByDay[dateKey].na++;
                        totalNA++;
                    }
                });

                // Affichage dans la section "Analyse des donn√©es"
                const naInfoInGaps = document.getElementById('naInfoInGaps');
                const naStatsInGaps = document.getElementById('naStatsInGaps');
                
                const naPercentage = totalRecords > 0 ? (totalNA / totalRecords * 100).toFixed(2) : 0;

                // Toujours afficher la section NA
                naInfoInGaps.style.display = 'block';

                if (totalNA === 0) {
                    naStatsInGaps.innerHTML = `
                        <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 10px; text-align: center;">
                            <span style="color: #27ae60; font-weight: 500;">‚úÖ Aucune valeur manquante</span>
                            <div style="font-size: 0.9em; color: #666; margin-top: 5px;">
                                ${totalRecords} mesures compl√®tes
                            </div>
                        </div>
                    `;
                } else {
                    const daysWithNA = Object.values(naByDay).filter(day => day.na > 0).length;
                    
                    naStatsInGaps.innerHTML = `
                        <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 10px;">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 10px; text-align: center;">
                                <div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #e74c3c;">${totalNA}</div>
                                    <div style="font-size: 0.8em; color: #666;">Valeurs NA</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #e74c3c;">${naPercentage}%</div>
                                    <div style="font-size: 0.8em; color: #666;">Du total</div>
                                </div>
                                <div>
                                    <div style="font-size: 1.2em; font-weight: bold; color: #e74c3c;">${daysWithNA}</div>
                                    <div style="font-size: 0.8em; color: #666;">Jours affect√©s</div>
                                </div>
                            </div>
                        </div>
                    `;
                }

                this.log(`üìä Analyse NA: ${totalNA} valeurs manquantes sur ${totalRecords} (${naPercentage}%)`, 
                         totalNA > 0 ? 'warning' : 'success');
            }

            resetStats() {
                this.stats = {
                    totalRecords: 0,
                    filesProcessed: 0,
                    overlapsFound: 0,
                    timeChanges: 0
                };
            }

            clearAll() {
                this.files = [];
                this.consolidatedData = [];
                this.overlaps = [];
                this.updateProcessButton();
                document.getElementById('downloadSection').style.display = 'none';
                document.getElementById('statsContainer').style.display = 'none';
                document.getElementById('periodInfo').style.display = 'none';
                document.getElementById('consumptionSummary').style.display = 'none';
                document.getElementById('weeklyConsumptionSummary').style.display = 'none';
                document.getElementById('naAnalysis').style.display = 'none';
                document.getElementById('logContent').innerHTML = '';
                this.log('üóëÔ∏è Tout a √©t√© effac√©. Pr√™t pour un nouveau traitement!', 'info');
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            log(message, type = 'info') {
                const logContent = document.getElementById('logContent');
                const logItem = document.createElement('div');
                logItem.className = `log-item log-${type}`;
                
                const timestamp = new Date().toLocaleTimeString('fr-FR');
                logItem.textContent = `[${timestamp}] ${message}`;
                
                logContent.appendChild(logItem);
                logContent.scrollTop = logContent.scrollHeight;
            }
        }

        // Initialiser l'application
        const consolidator = new EnedisConsolidator();
    </script>
</body>
</html>